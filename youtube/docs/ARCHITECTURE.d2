direction: right

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 1
  }
}

title: {
  label: "üé• Distributed Video Transcoding System - Async Message Flow"
  near: top-center
  shape: text
  style: {
    font-size: 32
    bold: true
    fill: "#1e293b"
  }
}

# Legend
legend: Legend {
  style.fill: "#fafaf9"
  style.stroke: "#44403c"
  style.stroke-width: 2
  
  l1: {
    label: "üîµ API / User Interface"
    shape: rectangle
    style.fill: "#3b82f6"
    style.font-color: "#ffffff"
  }
  
  l2: {
    label: "üü£ Orchestrator (Async)"
    shape: rectangle
    style.fill: "#8b5cf6"
    style.font-color: "#ffffff"
  }
  
  l3: {
    label: "üü° Message Queue"
    shape: queue
    style.fill: "#fbbf24"
  }
  
  l4: {
    label: "üü¢ Worker Pool"
    shape: rectangle
    style.fill: "#22c55e"
    style.font-color: "#ffffff"
  }
  
  l5: {
    label: "üü† Storage"
    shape: cylinder
    style.fill: "#f97316"
  }
  
  l6: {
    label: "‚îÄ ‚îÄ ‚îÄ ‚ñ∂ Async Message"
    shape: text
  }
  
  l7: {
    label: "‚îÅ‚îÅ‚îÅ‚îÅ‚ñ∂ Sync Call"
    shape: text
  }
}

# User Entry Point
user: {
  label: "üë§ User"
  shape: person
  style.fill: "#3b82f6"
  style.stroke: "#1e40af"
}

# API Gateway
api: {
  label: "FastAPI\n:8000"
  shape: rectangle
  style.fill: "#3b82f6"
  style.stroke: "#1e40af"
  style.font-color: "#ffffff"
  style.font-size: 16
}

# Temporal Orchestrator (Async Hub)
orchestrator: {
  label: "‚ö° Temporal Orchestrator\n(Async Message Publisher)"
  shape: rectangle
  style.fill: "#8b5cf6"
  style.stroke: "#6d28d9"
  style.font-color: "#ffffff"
  style.font-size: 16
  style.bold: true
}

# Stage 1: Download
stage1: Stage 1 - Download {
  style.fill: "#eff6ff"
  style.stroke: "#3b82f6"
  style.stroke-width: 2
  
  q1: {
    label: "üì• download-queue"
    shape: queue
    style.fill: "#bfdbfe"
    style.stroke: "#3b82f6"
  }
  
  w1: {
    label: "Download Workers\n(2 replicas)"
    shape: rectangle
    style.fill: "#22c55e"
    style.stroke: "#16a34a"
    style.font-color: "#ffffff"
    style.multiple: true
  }
  
  s1: {
    label: "MinIO\nsource.mp4"
    shape: cylinder
    style.fill: "#f97316"
    style.stroke: "#ea580c"
  }
  
  q1 -> w1: "Poll & Process"
  w1 -> s1: "Upload"
}

# Stage 2: Metadata
stage2: Stage 2 - Metadata {
  style.fill: "#faf5ff"
  style.stroke: "#8b5cf6"
  style.stroke-width: 2
  
  q2: {
    label: "üìä metadata-queue"
    shape: queue
    style.fill: "#ddd6fe"
    style.stroke: "#8b5cf6"
  }
  
  w2: {
    label: "Metadata Worker\n(1 replica)"
    shape: rectangle
    style.fill: "#22c55e"
    style.stroke: "#16a34a"
    style.font-color: "#ffffff"
  }
  
  s2: {
    label: "MinIO\nRead metadata"
    shape: cylinder
    style.fill: "#f97316"
    style.stroke: "#ea580c"
  }
  
  q2 -> w2: "Poll & Process"
  w2 -> s2: "Extract"
}

# Stage 3: Split
stage3: Stage 3 - Split {
  style.fill: "#fffbeb"
  style.stroke: "#f59e0b"
  style.stroke-width: 2
  
  q3: {
    label: "‚úÇÔ∏è split-queue"
    shape: queue
    style.fill: "#fde68a"
    style.stroke: "#f59e0b"
  }
  
  w3: {
    label: "Split Worker\n(1 replica)"
    shape: rectangle
    style.fill: "#22c55e"
    style.stroke: "#16a34a"
    style.font-color: "#ffffff"
  }
  
  s3: {
    label: "MinIO\nchunks/ + manifest"
    shape: cylinder
    style.fill: "#f97316"
    style.stroke: "#ea580c"
  }
  
  q3 -> w3: "Poll & Process"
  w3 -> s3: "Upload"
}

# Stage 4: Transcode (Critical Path)
stage4: Stage 4 - Transcode (Parallel) {
  style.fill: "#fef2f2"
  style.stroke: "#ef4444"
  style.stroke-width: 3
  
  q4: {
    label: "‚öôÔ∏è transcode-queue\n(N√óM tasks)"
    shape: queue
    style.fill: "#fca5a5"
    style.stroke: "#ef4444"
    style.bold: true
  }
  
  w4: {
    label: "üöÄ Transcode Workers\n(4 replicas)\nCPU-Intensive"
    shape: rectangle
    style.fill: "#22c55e"
    style.stroke: "#16a34a"
    style.font-color: "#ffffff"
    style.multiple: true
    style.bold: true
  }
  
  s4: {
    label: "MinIO\noutputs/{res}/segments/"
    shape: cylinder
    style.fill: "#f97316"
    style.stroke: "#ea580c"
  }
  
  q4 -> w4: "Poll & Process\n(Parallel)"
  w4 -> s4: "Upload"
}

# Stage 5: Merge
stage5: Stage 5 - Merge {
  style.fill: "#f0fdf4"
  style.stroke: "#22c55e"
  style.stroke-width: 2
  
  q5: {
    label: "üîó merge-queue"
    shape: queue
    style.fill: "#86efac"
    style.stroke: "#22c55e"
  }
  
  w5: {
    label: "Merge Workers\n(2 replicas)"
    shape: rectangle
    style.fill: "#22c55e"
    style.stroke: "#16a34a"
    style.font-color: "#ffffff"
    style.multiple: true
  }
  
  s5: {
    label: "MinIO\nencoded/{video_id}_{res}.mp4"
    shape: cylinder
    style.fill: "#f97316"
    style.stroke: "#ea580c"
  }
  
  q5 -> w5: "Poll & Process"
  w5 -> s5: "Upload Final"
}

# Stage 6: Cleanup
stage6: Stage 6 - Cleanup {
  style.fill: "#f8fafc"
  style.stroke: "#64748b"
  style.stroke-width: 2
  
  q6: {
    label: "üóëÔ∏è split-queue\n(cleanup task)"
    shape: queue
    style.fill: "#cbd5e1"
    style.stroke: "#64748b"
  }
  
  w6: {
    label: "Split Worker\n(cleanup mode)"
    shape: rectangle
    style.fill: "#64748b"
    style.stroke: "#475569"
    style.font-color: "#ffffff"
  }
  
  q6 -> w6: "Poll & Delete"
}

# Main Flow - User to API
user -> api: "1. POST /transcode\nvideo_id + url" {
  style.stroke: "#3b82f6"
  style.stroke-width: 3
}

# API to Orchestrator (Sync)
api -> orchestrator: "2. Start Workflow\n(Sync RPC)" {
  style.stroke: "#8b5cf6"
  style.stroke-width: 3
}

# Orchestrator publishes async messages to queues
orchestrator -> stage1.q1: "Publish\nDownload Task" {
  style.stroke: "#3b82f6"
  style.stroke-width: 2
  style.stroke-dash: 5
  style.animated: true
}

orchestrator -> stage2.q2: "Publish\nMetadata Task" {
  style.stroke: "#8b5cf6"
  style.stroke-width: 2
  style.stroke-dash: 5
  style.animated: true
}

orchestrator -> stage3.q3: "Publish\nSplit Task" {
  style.stroke: "#f59e0b"
  style.stroke-width: 2
  style.stroke-dash: 5
  style.animated: true
}

orchestrator -> stage4.q4: "Publish\nN√óM Transcode Tasks" {
  style.stroke: "#ef4444"
  style.stroke-width: 3
  style.stroke-dash: 5
  style.animated: true
}

orchestrator -> stage5.q5: "Publish\nMerge Tasks" {
  style.stroke: "#22c55e"
  style.stroke-width: 2
  style.stroke-dash: 5
  style.animated: true
}

orchestrator -> stage6.q6: "Publish\nCleanup Task" {
  style.stroke: "#64748b"
  style.stroke-width: 2
  style.stroke-dash: 5
}

# Info Notes
async_note: |md
  ## ‚ö° Asynchronous Message Flow
  **Temporal Orchestrator** acts as an async message publisher:
  - **Publishes** tasks to queues (fire-and-forget)
  - **Workers poll** independently from queues
  - **No blocking:** Orchestrator doesn't wait for completion
  - **State tracking:** Temporal stores workflow state in DB
  - **Retries:** Automatic on worker failures
| {
  shape: text
  style.fill: "#fefce8"
  style.stroke: "#facc15"
  style.stroke-width: 2
}

parallel_note: |md
  ## üöÄ Massive Parallelism (Stage 4)
  **Example:** 60-second video @ 4s chunks
  - **15 chunks** √ó **3 resolutions** = **45 tasks**
  - All queued **instantly** by orchestrator
  - **4 workers** process in parallel
  - Completes in **~1/4 the time** vs serial
| {
  shape: text
  style.fill: "#fef2f2"
  style.stroke: "#ef4444"
  style.stroke-width: 2
}

scaling_note: |md
  ## ‚öñÔ∏è Horizontal Scaling
  - **Queue depth** triggers auto-scaling
  - **Workers** are stateless containers
  - **Add replicas** without code changes
  - **Kubernetes HPA** ready
| {
  shape: text
  style.fill: "#f0fdf4"
  style.stroke: "#22c55e"
  style.stroke-width: 2
}
